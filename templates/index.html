<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Party Q</title>
  <meta name="description" content="PartyQ">

</head>

<body>
  <form id="song-form">
    Song:<br>
    <input type="text" name="song" value=""><br><br>
    <button id="song-button" type="submit">Submit</button>
  </form>
  <div id="response-text">
  </div>
  <div id="results">
  </div>
  <script>
    function displayResults(results) {
      var resultlist = document.getElementById("results")
      results.forEach((res) => {
          let listitem = document.createElement("div")
          let artistname = res.artists[0].name 
          // let thumbnail = res.thumbnails[0].url
          listitem.innerHTML = `${artistname} - ${res.title}`
          listitem.setAttribute("videoId", res.videoId)
          let link = document.createElement("a")
          link.appendChild(listitem)
          resultlist.appendChild(link)
          link.addEventListener("click", (e) => {
            console.log(e.target)
            let videoId = e.target.getAttribute("videoId")
            req  = {videoId}
            fetch(`${window.origin}/add`, {
              method: "POST",
              body: JSON.stringify(req)
            })
          })
      })
    }

    var response_text = document.getElementById("response-text")
    var form = document.getElementById("song-form")

    function sendData(e) {
      e.preventDefault()
      var formData = new FormData(e.target)
      console.log(Object.fromEntries(formData))
      fetch(window.origin, {
        method: "post",
        body: formData
      }).then((res) => {
        if (!res.ok) {
          response_text.innerHTML = "There was an error submitting song request"
        }
        else {
          response_text.innerHTML = "Song Submitted"
          return res
        }
      })
      .then((res) => res.json())
      .then((res) => displayResults(res))

      var inputs = e.target.getElementsByTagName("input")
      for (let i = 0; i < inputs.length; ++i) {
        inputs[i].value = ""
      }
    }

    form.addEventListener("submit", sendData)
    const socket = new WebSocket(`ws://${window.location.hostname}/qinfo`)

    socket.addEventListener("open", (event) => {
      console.log("socket open")
    })

    socket.addEventListener("message", (event) => {
      console.log("Message from server ", event.data);
    })
  </script>
</body>
</html>
